name: Sync OAS to actual_repo

on:
  push:
    paths:
      - "generated/**/spec.yaml"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo-A (temprepo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed OAS file(s)
        id: detect
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD | grep "generated/.*/spec.yaml" || true)
          if [ -z "$FILES" ]; then
            echo "none=true" >> $GITHUB_OUTPUT
          else
            echo "none=false" >> $GITHUB_OUTPUT
            echo "FILES<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Stop if nothing changed
        if: steps.detect.outputs.none == 'true'
        run: echo "No OAS changes detected."

      - name: Setup GitHub CLI
        if: steps.detect.outputs.none == 'false'
        run: |
          echo "${{ secrets.REPO_B_TOKEN }}" | gh auth login --with-token

      - name: Process each changed file
        if: steps.detect.outputs.none == 'false'
        env:
          GH_TOKEN: ${{ secrets.REPO_B_TOKEN }}
        run: |
          set -e

          for SRC in ${{ steps.detect.outputs.FILES }}; do
            # Example: generated/acme/service-a/foo/bar/spec.yaml
            DEST="${SRC#generated/}"

            BRANCH="oas-sync-$(date +%s)"

            echo "=== Syncing $SRC to actual_repo:$DEST ==="

            # Clone Repo-B
            git clone "https://x-access-token:${GH_TOKEN}@github.com/setia141/actual_repo.git" repo-b
            cd repo-b

            git config user.name "github-actions"
            git config user.email "github-actions@github.com"

            # Checkout from NPE or create
            if git ls-remote --exit-code --heads origin NPE >/dev/null 2>&1; then
              git checkout -b "$BRANCH" origin/NPE
            else
              git checkout -b "$BRANCH"
            fi

            cd ..

            # Ensure folder exists & copy file
            mkdir -p "repo-b/$(dirname "$DEST")"
            cp "$SRC" "repo-b/$DEST"

            cd repo-b
            git add "$DEST"

            # Skip if no real change
            if git diff --staged --quiet; then
              echo "No actual change for $DEST"
              cd ..
              rm -rf repo-b
              continue
            fi

            git commit -m "Auto-sync OAS update for $DEST"
            git push -u origin "$BRANCH"

            # Create PR
            gh pr create \
              --base "NPE" \
              --head "$BRANCH" \
              --title "Auto-sync OAS for $DEST" \
              --body "Automated OAS update from temprepo" || true

            cd ..
            rm -rf repo-b

          done
