name: Sync YAML files to actual_repo

on:
  push:
    paths:
      - "generated/**/*.yaml"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo-A
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed YAML files
        id: detect
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD | grep "^generated/.*\.yaml$" || true)
          if [ -z "$FILES" ]; then
            echo "none=true" >> $GITHUB_OUTPUT
          else
            echo "none=false" >> $GITHUB_OUTPUT
            echo "FILES<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Stop if nothing changed
        if: steps.detect.outputs.none == 'true'
        run: echo "No YAML changes detected."

      - name: Install GH CLI
        if: steps.detect.outputs.none == 'false'
        run: |
          echo "${{ secrets.REPO_B_TOKEN }}" | gh auth login --with-token

      - name: Process changed files
        if: steps.detect.outputs.none == 'false'
        env:
          GH_TOKEN: ${{ secrets.REPO_B_TOKEN }}
        run: |
          set -e

          for SRC in ${{ steps.detect.outputs.FILES }}; do
            # Strip "generated/"
            DEST="${SRC#generated/}"

            BRANCH="sync-$(date +%s)"

            echo "=== Syncing $SRC -> actual_repo:$DEST ==="

            # Clone Repo-B
            git clone "https://x-access-token:${GH_TOKEN}@github.com/setia141/actual_repo.git" repo-b
            cd repo-b

            git config user.name "github-actions"
            git config user.email "github-actions@github.com"

            # Checkout from NPE or create
            if git ls-remote --exit-code --heads origin NPE >/dev/null 2>&1; then
              git checkout -b "$BRANCH" origin/NPE
            else
              git checkout -b "$BRANCH"
            fi

            cd ..

            # Ensure folder exists, copy file
            mkdir -p "repo-b/$(dirname "$DEST")"
            cp "$SRC" "repo-b/$DEST"

            cd repo-b

            git add "$DEST"

            # Skip if no meaningful diff
            if git diff --staged --quiet; then
              echo "No actual change for $DEST"
              cd ..
              rm -rf repo-b
              continue
            fi

            git commit -m "Auto-sync $DEST"
            git push -u origin "$BRANCH"

            # Create PR
            gh pr create \
              --base "NPE" \
              --head "$BRANCH" \
              --title "Auto-sync YAML update: $DEST" \
              --body "Automated sync from temprepo" || true

            cd ..
            rm -rf repo-b
          done
